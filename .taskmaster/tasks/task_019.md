# Task ID: 19

**Title:** Implement data export API with JSON and PDF formats

**Status:** pending

**Dependencies:** 8

**Priority:** medium

**Description:** Build export functionality that generates downloadable archives of user's journal data in JSON format and print-ready PDF format with all entries and media references.

**Details:**

Create `src/routes/api/export.ts` with endpoints:

**GET /api/export/json**
- Query all entries, media, reminders for user
- Generate JSON structure:
```json
{
  "user": { "email", "displayName", "exportDate" },
  "entries": [
    {
      "id", "entryDate", "rawContent", "polishedContent",
      "type", "source", "mood", "tags", "location",
      "media": [{ "id", "type", "url", "transcription" }]
    }
  ],
  "stats": { "totalEntries", "firstEntry", "lastEntry" }
}
```
- Set Content-Disposition header for download
- Filename: `journalizer-export-{userId}-{date}.json`

**GET /api/export/pdf** (query params: startDate?, endDate?)
- Use pdf-lib or Puppeteer (via Browserless worker) to generate PDF
- Template:
  - Cover page: "Journal of {displayName}" with date range
  - Table of contents with page numbers
  - Entries: One per page or continuous, with date headers, polished content, media thumbnails (embedded), mood icons
  - Footer: Page numbers, "Generated by Journalizer"
- For media: Embed thumbnails, include "[Audio/Video recording attached]" placeholders
- Filename: `journalizer-{startDate}-{endDate}.pdf`

Glass spec:
- `glass/routes/export.glass` - Intent: portable data export; Contract: guarantees complete data inclusion, media reference accuracy, PDF formatting consistency, GDPR compliance

**Test Strategy:**

Test JSON export with various entry counts. Verify JSON structure is valid and includes all data. Test PDF generation with text-only entries and entries with media. Test date range filtering for PDF. Verify downloads work in all browsers. Test with large datasets (100+ entries).

## Subtasks

### 19.1. Implement GET /api/export/json endpoint with authentication

**Status:** pending  
**Dependencies:** None  

Create the JSON export endpoint in src/routes/api/export.ts with user authentication middleware and basic route structure.

**Details:**

Set up the export.ts route file with GET /api/export/json endpoint. Add authentication middleware to verify JWT session and extract userId. Create the basic handler function that will orchestrate the JSON export process. Include proper error handling for unauthenticated requests. Return 401 if no valid session exists.

### 19.2. Query all entries, media, and reminders for user from D1

**Status:** pending  
**Dependencies:** 19.1  

Implement database queries to fetch all user's journal entries with associated media attachments and reminder configurations from D1.

**Details:**

Write D1 queries to fetch: (1) all entries for userId with SELECT from journal_entries, (2) all media for those entries with JOIN or separate query to media_files, (3) all reminders with SELECT from reminders. Use prepared statements for security. Handle pagination or streaming for large datasets (100+ entries). Consider memory limits in Cloudflare Workers (128MB default). Order entries by entryDate descending.

### 19.3. Construct JSON export structure with user info and statistics

**Status:** pending  
**Dependencies:** 19.2  

Build the complete JSON export object including user metadata, entries with nested media, and calculated statistics.

**Details:**

Transform database results into the specified JSON structure: { user: { email, displayName, exportDate: new Date().toISOString() }, entries: [...], stats: { totalEntries, firstEntry, lastEntry } }. For each entry, include: id, entryDate, rawContent, polishedContent, type, source, mood, tags, location, and nested media array with { id, type, url, transcription }. Calculate stats from entry data. Ensure all fields are present even if null. Format dates consistently as ISO 8601 strings.

### 19.4. Set Content-Disposition header and return JSON download

**Status:** pending  
**Dependencies:** 19.3  

Configure response headers for file download and return the JSON export with appropriate filename.

**Details:**

Generate filename using pattern: journalizer-export-{userId}-{YYYY-MM-DD}.json. Set response headers: Content-Type: application/json, Content-Disposition: attachment; filename="{filename}". Return JSON string as response body. Ensure proper character encoding (UTF-8). Handle large JSON responses that may approach Worker response size limits.

### 19.5. Implement GET /api/export/pdf endpoint with date range query params

**Status:** pending  
**Dependencies:** 19.1  

Create PDF export endpoint with optional startDate and endDate query parameters for filtering entries.

**Details:**

Add GET /api/export/pdf route to export.ts with authentication middleware. Parse query params: startDate (ISO date string), endDate (ISO date string), both optional. Validate date formats and ensure startDate <= endDate. If no dates provided, export all entries. Query D1 for entries filtered by date range: WHERE entryDate >= startDate AND entryDate <= endDate. Include associated media for filtered entries.

### 19.6. Integrate pdf-lib for PDF generation in Workers environment

**Status:** pending  
**Dependencies:** 19.5  

Set up pdf-lib library for PDF document creation compatible with Cloudflare Workers runtime constraints.

**Details:**

Install pdf-lib package (pure JavaScript, works in Workers). Import PDFDocument, StandardFonts, rgb from pdf-lib. Create basic PDF generation function that initializes a PDFDocument, adds pages, and returns PDF bytes. Handle Workers memory constraints (128MB). Consider alternative: If pdf-lib limitations arise, prepare integration point for external Browserless service (Cloudflare Worker can make fetch requests to Browserless API). Test basic PDF creation works in Workers environment.

### 19.7. Design and implement PDF template structure

**Status:** pending  
**Dependencies:** 19.6  

Create PDF template with cover page, table of contents, entry pages with headers, and footer with page numbers.

**Details:**

Implement PDF layout: (1) Cover page - title 'Journal of {displayName}', subtitle with date range '{startDate} - {endDate}', centered text with large font. (2) Table of Contents page - list entry dates and page numbers (calculate after layout). (3) Entry pages - each entry with date header (bold, 16pt), polished content (body text, 12pt), mood icon representation (text emoji), tags list, location if present. (4) Footer on every page except cover: 'Generated by Journalizer' (left), page number (right). Use pdf-lib page.drawText() with proper positioning, fonts (Helvetica, Times-Roman), and spacing.

### 19.8. Embed media thumbnails in PDF from R2 storage

**Status:** pending  
**Dependencies:** 19.7  

Fetch media thumbnails from R2 and embed them as images in PDF entry pages using pdf-lib image embedding.

**Details:**

For each entry with media: (1) Fetch thumbnail from R2 using media.url (or generate thumbnail URL pattern). (2) Download image bytes using fetch(). (3) Embed in PDF using pdfDoc.embedJpg() or embedPng() based on media type. (4) Draw image on page using page.drawImage() with dimensions (max 200x200px to fit layout). (5) Position thumbnail below entry text. Handle errors gracefully if media fetch fails (skip image, continue PDF generation). Add '[Image]' text placeholder if embedding fails. Consider memory limits - may need to process images in batches.

### 19.9. Add audio/video placeholders in PDF for non-embeddable media

**Status:** pending  
**Dependencies:** 19.8  

Insert text placeholders for audio and video media that cannot be embedded directly in PDF documents.

**Details:**

For media with type 'audio' or 'video': Insert text placeholder below entry content using page.drawText(): '[Audio recording attached: {filename}]' or '[Video recording attached: {filename}]'. Include media duration if available in metadata. Add hyperlink text (non-clickable) showing media URL for reference. Style placeholder with italic font or gray color to distinguish from body text. Position consistently with image thumbnails. Include transcription text below placeholder if transcription field is populated.

### 19.10. Create Glass spec for routes/export.glass with data completeness contract

**Status:** pending  
**Dependencies:** 19.4, 19.9  

Write Glass specification documenting export API intent, contracts for data completeness, GDPR compliance, and format accuracy.

**Details:**

Create glass/routes/export.glass file following GLASS.md conventions. Document: Intent - 'Provide portable data export in JSON and PDF formats for user data ownership and GDPR compliance'. Contract - 'Guarantees: (1) Complete data inclusion - all entries, media references, reminders exported without omission, (2) Media reference accuracy - all media URLs are valid and accessible, (3) PDF formatting consistency - readable layout across viewers, proper pagination, (4) GDPR compliance - exports contain all personal data, enable data portability right'. Include examples for both endpoints. Document error conditions and edge cases (empty export, large datasets, missing media).
