=== Glass Unit ===
id: services.transcription
version: 0.1.0
language: typescript

=== Intent ===
purpose: Convert audio and video files to text using Deepgram Nova-3 speech-to-text API. Supports both direct audio upload and R2-stored media. Transcripts are used as raw content for journal entries, then passed to AI polish.
source:
  kind: prd
  reference: "PRD Section 8.2 — Audio/Video Transcription (Deepgram)"
parent: null
stakeholder: user
subIntents: []
approvalStatus: approved

=== Contract ===
requires:
  - "DEEPGRAM_API_KEY is configured as a Worker secret"
  - "Audio source is valid audio/video data or a URL"
guarantees:
  on_success:
    - "Returns transcript text with punctuation and paragraph breaks"
    - "Speaker diarization is enabled for multi-speaker content"
    - "Confidence score, duration, and word count are tracked"
    - "Processing is logged to D1 processing_log table"
  on_failure:
    - "API errors include status code and Deepgram error message"
    - "R2 fetch failures are logged with the R2 key"
    - "All failures are logged to processing_log"
invariants:
  - "Every transcription attempt is logged (success or failure)"
  - "R2 objects are read but never modified by this service"
fails:
  ApiError: "Log failure with Deepgram status code, propagate error"
  R2ObjectNotFound: "Log failure, throw with R2 key context"
  EmptyTranscript: "Throw error (no transcript returned)"
advisories:
  - "Deepgram Nova-3 costs ~$0.0043/min — monitor for cost spikes"
  - "Video audio extraction not yet implemented — send full video file to Deepgram"
