=== Glass Unit ===
id: services.digest
version: 0.1.0
language: typescript

=== Intent ===
purpose: Generate daily digest entries that summarize all journal entries for a given day into a cohesive narrative. Single-entry days use content as-is (no AI call); multi-entry days use Claude Haiku to weave entries into a chronological narrative respecting the user's voice style.
source:
  kind: conversation
  reference: "User request — daily digest feature for journal book preparation"
parent: null
stakeholder: user
subIntents: []
approvalStatus: approved

=== Contract ===
requires:
  - "ANTHROPIC_API_KEY is configured as a Worker secret"
  - "Entries for the target date exist in D1"
  - "User has valid voice style setting"
guarantees:
  on_success:
    - "Single-entry days produce a digest using the entry's content directly (no AI call)"
    - "Multi-entry days produce an AI-generated chronological narrative"
    - "Voice style preference (natural/conversational/reflective/polished) is respected"
    - "Custom voice notes are incorporated into the digest prompt"
    - "Digest entry created with entryType=digest, source=system"
    - "digest_entries join records link digest to all source entries"
    - "user.lastDigestDate updated to prevent duplicate generation"
    - "Token usage logged to processing_log for AI-generated digests"
    - "Telegram notification sent if user has linked chat"
    - "Source entries' media accessible via digest_entries join table"
  on_failure:
    - "Errors logged to processing_log with digest_generated action"
    - "No partial digest created — operation is atomic via batch insert"
invariants:
  - "AI never adds content the author didn't write"
  - "One digest per user per day (enforced by lastDigestDate check)"
  - "Media is not duplicated — referenced at query time via join table"
fails:
  AnthropicError: "Log failure, skip digest for this date"
  EmptyResponse: "Throw error — do not persist blank digests"
  NoEntries: "Update lastDigestDate, skip digest creation"
advisories:
  - "Using claude-3-5-haiku for speed and cost — consider Sonnet for quality"
